
  <!DOCTYPE html>
  <html id="" class="">
    <!-- OriginalSrc: http://cogito.thisillusion.org/?p=652 -->
    <head>
      <meta http-equiv="Content-Type" content="text/html"; charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />

      <title>搞定Lucifen，再次体会到rUGP有多难 | 木之</title>
      

<link rel="stylesheet" type="text/css" media="all" href="assets/1570118322-ae01e21417744c1a8d0711b783ec44f5.css" referrerpolicy="no-referrer">


<style class="darkreader darkreader--fallback" media="screen"></style>
<style class="darkreader darkreader--text" media="screen"></style>
<style class="darkreader darkreader--invert" media="screen"></style>
<style class="darkreader darkreader--inline" media="screen">[data-darkreader-inline-bgcolor] {
  background-color: var(--darkreader-inline-bgcolor) !important;
}
[data-darkreader-inline-bgimage] {
  background-image: var(--darkreader-inline-bgimage) !important;
}
[data-darkreader-inline-border] {
  border-color: var(--darkreader-inline-border) !important;
}
[data-darkreader-inline-border-bottom] {
  border-bottom-color: var(--darkreader-inline-border-bottom) !important;
}
[data-darkreader-inline-border-left] {
  border-left-color: var(--darkreader-inline-border-left) !important;
}
[data-darkreader-inline-border-right] {
  border-right-color: var(--darkreader-inline-border-right) !important;
}
[data-darkreader-inline-border-top] {
  border-top-color: var(--darkreader-inline-border-top) !important;
}
[data-darkreader-inline-boxshadow] {
  box-shadow: var(--darkreader-inline-boxshadow) !important;
}
[data-darkreader-inline-color] {
  color: var(--darkreader-inline-color) !important;
}
[data-darkreader-inline-fill] {
  fill: var(--darkreader-inline-fill) !important;
}
[data-darkreader-inline-stroke] {
  stroke: var(--darkreader-inline-stroke) !important;
}
[data-darkreader-inline-outline] {
  outline-color: var(--darkreader-inline-outline) !important;
}</style>
<style class="darkreader darkreader--user-agent" media="screen">html {
    background-color: #191a1b !important;
}
html, body, input, textarea, select, button {
    background-color: #191a1b;
}
html, body, input, textarea, select, button {
    border-color: #5a5956;
    color: #f0ebe2;
}
a {
    color: #4791e7;
}
table {
    border-color: #4f4e4c;
}
::placeholder {
    color: #bfb9ac;
}
::selection {
    background-color: #125cb4;
    color: #fffffd;
}
::-moz-selection {
    background-color: #125cb4;
    color: #fffffd;
}
input:-webkit-autofill,
textarea:-webkit-autofill,
select:-webkit-autofill {
    background-color: #565a0f !important;
    color: #f0ebe2 !important;
}
::-webkit-scrollbar {
    background-color: #1d1f1f;
    color: #cbc5b9;
}
::-webkit-scrollbar-thumb {
    background-color: #2c2d2d;
}
::-webkit-scrollbar-thumb:hover {
    background-color: #343636;
}
::-webkit-scrollbar-thumb:active {
    background-color: #404142;
}
::-webkit-scrollbar-corner {
    background-color: #191a1b;
}
* {
    scrollbar-color: #2c2d2d #1d1f1f;
}</style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style class="darkreader darkreader--override" media="screen">.jfk-bubble {
    background-color: #000000 !important;
}
.vimvixen-hint {
    background-color: #765500 !important;
    border-color: #d5b22e !important;
    color: #f9edcc !important;
}</style>
<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style type="text/css">@keyframes fadeInOpacity{0%{opacity:0}to{opacity:1}}:hover>*>.fbvd--wrapper{animation-name:fadeInOpacity;animation-duration:.3s;opacity:1}.fbvd--wrapper{position:absolute;top:10px;left:10px;opacity:0;text-align:center;margin:0;z-index:5}.fbvd--wrapper a{background: url("") no-repeat 3px 4.55px; background-color: #fff; display:inline-block;font:700 14px Helvetica,Arial,sans-serif;color:#4b4f56;text-decoration:none;vertical-align:middle;padding:0px 8px 0px;margin-right:8px;border-radius:2px; line-height: 22px; padding-left:19px; border: 1px solid #e7e7e7; background-size: 13px}.fbvd--wrapper a:last-child{margin-right:0}.fbvd--wrapper a:hover{text-decoration:none}.fbvd--wrapper a:focus{box-shadow:0 0 1px 2px rgba(88,144,255,.75),0 1px 1px rgba(0,0,0,.15);outline:none}.fbvd--wrapper b{font-size:13px;position:relative;top:1px;color:#3b5998;font-weight:400}</style>
<style class="darkreader darkreader--sync" media="screen"></style>

      
    </head>
    <body class="post-template-default single single-post postid-652 single-format-standard single-author singular two-column right-sidebar mx-wc-selected-elem mx-wc-1570118322" style="">
<div id="page" class="hfeed">
	<header id="branding" role="banner">
			<hgroup>
				<h1 id="site-title"><span><a href="http://cogito.thisillusion.org/" rel="noopener noreferrer" target="_blank" referrerpolicy="no-referrer">木之</a></span></h1>
				<h2 id="site-description"></h2>
			</hgroup>

						<a href="http://cogito.thisillusion.org/" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer">
									<img src="assets/1570118322-c1af564ca2e15bb7ed35f106fbc9cca1.jpg" width="1000" height="288" alt="木之">
							</a>
			
								<form method="get" id="searchform" action="http://cogito.thisillusion.org/">
		<label for="s" class="assistive-text">Search</label>
		<input type="text" class="field" name="s" id="s" placeholder="Search">
		
	</form>
			
			<nav id="access" role="navigation">
				<h3 class="assistive-text">Main menu</h3>
								<div class="skip-link"><a class="assistive-text" href="#content">Skip to primary content</a></div>
												<div class="menu"><ul>
<li><a href="http://cogito.thisillusion.org/" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer">Home</a></li><li class="page_item page-item-8"><a href="http://cogito.thisillusion.org/?page_id=8" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer">About</a></li>
<li class="page_item page-item-2"><a href="http://cogito.thisillusion.org/?page_id=2" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer">Sample Page</a></li>
</ul></div>
			</nav><!-- #access -->
	</header><!-- #branding -->


	<div id="main">

		<div id="primary">
			<div id="content" role="main">

				
					<nav id="nav-single">
						<h3 class="assistive-text">Post navigation</h3>
						<span class="nav-previous"><a href="http://cogito.thisillusion.org/?p=650" rel="noopener noreferrer" target="_blank" referrerpolicy="no-referrer"><span class="meta-nav">←</span> Previous</a></span>
						<span class="nav-next"><a href="http://cogito.thisillusion.org/?p=655" rel="noopener noreferrer" target="_blank" referrerpolicy="no-referrer">Next <span class="meta-nav">→</span></a></span>
					</nav><!-- #nav-single -->

					
<article id="post-652" class="post-652 post type-post status-publish format-standard hentry category-uncategorized">
	<header class="entry-header">
		<h1 class="entry-title">搞定Lucifen，再次体会到rUGP有多难</h1>

				<div class="entry-meta">
			<span class="sep">Posted on </span><a href="http://cogito.thisillusion.org/?p=652" title="4:20 pm" rel="noopener noreferrer" target="_blank" referrerpolicy="no-referrer"><time class="entry-date" datetime="2016-08-24T16:20:50+00:00">August 24, 2016</time></a>		</div><!-- .entry-meta -->
			</header><!-- .entry-header -->

	<div class="entry-content">
		<p>7月底，暂离汉化一周年，忽然动了翻俺翼的念头，于是开始搞俺翼R的程序。出乎意料的是，只花了二十多天的业余时间，就把从解包到剧本封包的主要问题都解决了。跟当年搞君望LE的程序一比，天上地下——解决君望LE的解包和初步封包前后花了大半年。单纯以花费的时间衡量的话，君望LE大约比俺翼R难十倍到二十倍。即使考虑自身水平提高、改用Python开发、资料更丰富等因素，也无法忽视两种引擎复杂度的巨大差别。</p>
<p>首先是封包格式和对象种类。俺翼R等Lucifen引擎的游戏有多个LPK包，分别存放脚本、背景、立绘、语音等内容，每个包开头的前缀树和索引数组里记录着包内所有对象的文件名和位置大小。Crass早已提供了前缀树和索引数组的解码算法，只需要跟程序抓一下密钥就能用了……即使不会解析其中某些对象，至少能拆开LPK包。相比之下，君望LE的rio文件没有全局索引，而是把所有对象存成树形。一个对象如何连接到子对象与它的类型、内容有关，只有正确解析了一个对象，才能确认它的子对象存在哪儿、有多大。把rio文件中的所有对象取出来，几乎等于解析所有对象。这是一个可怕的工作：君望LE中已经确认的对象类型不少于88种，而且都是需要进一步解析的二进制数据。相比之下，俺翼R的LPK包解开后，需要进一步解析的基本只有elg、sob、tob三种对象。</p>
<p>图片解析方面差别不大。君望LE这边，westside的四个函数可以合并成一个；俺翼R这边，Crass的四个函数可以合并成两个。当然，原来的算法都是有效的；不过既然做静态替换，需要写逆算法的函数自然是越少越好。两边的难度都在算法清理和合并，写逆算法并不难。</p>
<p>脚本的情况和外层封包类似，虽然都是二进制脚本，但是俺翼R有全局索引信息和强特征，君望LE没有。俺翼R的tob脚本开头有记录命令组分割点的数组，而且命令组中除可自由调整的剧本正文外，每条命令开头都有特定标记。于是，很容易分割命令和提取文本，封包也不用顾忌正文长度的改变。君望LE的脚本复杂得多，11种脚本对象的解析依赖于更深一层约300种命令对象的解析，而且缺少共通的结构。我在RioX中采用的方法是，对假设树剪枝以定位每个对象开头的标记双字。虽然这个双字没有强特征，但是相邻对象标记双字的差和对象长度之间存在弱对应关系。一般情况下扫完整个脚本，假设树中就只剩一个假设了。封包时，对象长度有限制，标记双字也需要调整。</p>
<p>解决了解包封包，处理中文显示就有套路了：先改取字体的API，再改双字节字符判断。然后，就可以开始翻译了。</p>
			</div><!-- .entry-content -->

	<footer class="entry-meta">
		This entry was posted in <a href="http://cogito.thisillusion.org/?cat=1" rel="noopener noreferrer" target="_blank" referrerpolicy="no-referrer">Uncategorized</a> by <a href="http://cogito.thisillusion.org/?author=1" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer">muzhi</a>. Bookmark the <a href="http://cogito.thisillusion.org/?p=652" title="Permalink to 搞定Lucifen，再次体会到rUGP有多难" rel="noopener noreferrer" target="_blank" referrerpolicy="no-referrer">permalink</a>.		
			</footer><!-- .entry-meta -->
</article><!-- #post-652 -->

						<div id="comments">
	
	
	
	
</div><!-- #comments -->

				
			</div><!-- #content -->
		</div><!-- #primary -->


	</div><!-- #main -->

	<footer id="colophon" role="contentinfo">

			

			<div id="site-generator">
								<a href="https://wordpress.org/" title="Semantic Personal Publishing Platform" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer">Proudly powered by WordPress</a>
			</div>
	</footer><!-- #colophon -->
</div><!-- #page -->





<span id="copylAddress" style="display: inline-block; position: absolute; left: -9999em;"></span><a href="" download="" data-mx-warn="Empty URL"></a><div data-mx-warn="extension url was not captured by MaoXian" data-mx-original-src="chrome-extension://kjahokgdcbohofgdidndeiaigkehdjdc/pages/ui-selection.html?t=aHR0cDovL2NvZ2l0by50aGlzaWxsdXNpb24ub3Jn"></div><div data-mx-warn="extension url was not captured by MaoXian" data-mx-original-src="chrome-extension://kjahokgdcbohofgdidndeiaigkehdjdc/pages/ui-control.html?t=aHR0cDovL2NvZ2l0by50aGlzaWxsdXNpb24ub3Jn"></div>
</body>
  </html>