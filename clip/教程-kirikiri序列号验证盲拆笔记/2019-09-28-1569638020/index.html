
  <!DOCTYPE html>
  <html id="" class="">
    <!-- OriginalSrc: https://bbs.zdfx.net/thread-385589-1-3.html -->
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />

      <title>【教程】kirikiri序列号验证盲拆笔记 - 教程区 - 终点分享</title>
      
<link rel="shortcut icon" href="assets/1569638020-e81b5947c7abaae78e35cec3bad71fe7.ico" referrerpolicy="no-referrer">


<link rel="stylesheet" type="text/css" href="assets/1569638020-85caba8cb02aef16de7600ede53263d0.css" referrerpolicy="no-referrer">
<link rel="stylesheet" type="text/css" href="assets/1569638020-a71dc544038114b44c836ab7027dd5d6.css" referrerpolicy="no-referrer">
<link rel="stylesheet" type="text/css" href="assets/1569638020-11a323f273480852d22a0b0679c3f978.css" referrerpolicy="no-referrer">
<link id="layuicss-skinlayimcss" rel="stylesheet" href="assets/1569638020-f6690d2203f1851c541d835534fa98da.css" media="all" referrerpolicy="no-referrer">
<link id="layuicss-layer" rel="stylesheet" href="assets/1569638020-f047d528d2d6935b6a85a420adabfcd3.css" media="all" referrerpolicy="no-referrer">
<link rel="stylesheet" href="assets/1569638020-0aeb79609e7a06f3fe31a5ddc96e9a2f.css" type="text/css" referrerpolicy="no-referrer">
<link rel="stylesheet" type="text/css" href="assets/1569638020-61d076fd3d2c7ae43e3259540ffa2a7b.css" referrerpolicy="no-referrer">
<link rel="stylesheet" href="assets/1569638020-0c06e8425b20c168d075ae68bb660e4d.css" referrerpolicy="no-referrer">
<link rel="stylesheet" href="assets/1569638020-e63ef21268f8c65167dde24ff3a4e783.css" referrerpolicy="no-referrer">
<link rel="stylesheet" type="text/css" href="assets/1569638020-6f1b46eaa6b3295a424d6a3902b5981f.css" referrerpolicy="no-referrer">
<link rel="stylesheet" type="text/css" href="assets/1569638020-8ab4276818474108cdb71c9a262f61ca.css" referrerpolicy="no-referrer">


<style class="darkreader darkreader--fallback" media="screen"></style>
<style class="darkreader darkreader--text" media="screen"></style>
<style class="darkreader darkreader--invert" media="screen"></style>
<style class="darkreader darkreader--inline" media="screen">[data-darkreader-inline-bgcolor] {
  background-color: var(--darkreader-inline-bgcolor) !important;
}
[data-darkreader-inline-bgimage] {
  background-image: var(--darkreader-inline-bgimage) !important;
}
[data-darkreader-inline-border] {
  border-color: var(--darkreader-inline-border) !important;
}
[data-darkreader-inline-border-bottom] {
  border-bottom-color: var(--darkreader-inline-border-bottom) !important;
}
[data-darkreader-inline-border-left] {
  border-left-color: var(--darkreader-inline-border-left) !important;
}
[data-darkreader-inline-border-right] {
  border-right-color: var(--darkreader-inline-border-right) !important;
}
[data-darkreader-inline-border-top] {
  border-top-color: var(--darkreader-inline-border-top) !important;
}
[data-darkreader-inline-boxshadow] {
  box-shadow: var(--darkreader-inline-boxshadow) !important;
}
[data-darkreader-inline-color] {
  color: var(--darkreader-inline-color) !important;
}
[data-darkreader-inline-fill] {
  fill: var(--darkreader-inline-fill) !important;
}
[data-darkreader-inline-stroke] {
  stroke: var(--darkreader-inline-stroke) !important;
}
[data-darkreader-inline-outline] {
  outline-color: var(--darkreader-inline-outline) !important;
}</style>
<style class="darkreader darkreader--user-agent" media="screen">html {
    background-color: #191a1b !important;
}
html, body, input, textarea, select, button {
    background-color: #191a1b;
}
html, body, input, textarea, select, button {
    border-color: #5a5956;
    color: #f0ebe2;
}
a {
    color: #4791e7;
}
table {
    border-color: #4f4e4c;
}
::placeholder {
    color: #bfb9ac;
}
::selection {
    background-color: #125cb4;
    color: #fffffd;
}
::-moz-selection {
    background-color: #125cb4;
    color: #fffffd;
}
input:-webkit-autofill,
textarea:-webkit-autofill,
select:-webkit-autofill {
    background-color: #565a0f !important;
    color: #f0ebe2 !important;
}
::-webkit-scrollbar {
    background-color: #1d1f1f;
    color: #cbc5b9;
}
::-webkit-scrollbar-thumb {
    background-color: #2c2d2d;
}
::-webkit-scrollbar-thumb:hover {
    background-color: #343636;
}
::-webkit-scrollbar-thumb:active {
    background-color: #404142;
}
::-webkit-scrollbar-corner {
    background-color: #191a1b;
}
* {
    scrollbar-color: #2c2d2d #1d1f1f;
}</style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style class="darkreader darkreader--override" media="screen">.jfk-bubble {
    background-color: #000000 !important;
}
.vimvixen-hint {
    background-color: #765500 !important;
    border-color: #d5b22e !important;
    color: #f9edcc !important;
}</style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style type="text/css">@keyframes fadeInOpacity{0%{opacity:0}to{opacity:1}}:hover>*>.fbvd--wrapper{animation-name:fadeInOpacity;animation-duration:.3s;opacity:1}.fbvd--wrapper{position:absolute;top:10px;left:10px;opacity:0;text-align:center;margin:0;z-index:5}.fbvd--wrapper a{background: url("") no-repeat 3px 4.55px; background-color: #fff; display:inline-block;font:700 14px Helvetica,Arial,sans-serif;color:#4b4f56;text-decoration:none;vertical-align:middle;padding:0px 8px 0px;margin-right:8px;border-radius:2px; line-height: 22px; padding-left:19px; border: 1px solid #e7e7e7; background-size: 13px}.fbvd--wrapper a:last-child{margin-right:0}.fbvd--wrapper a:hover{text-decoration:none}.fbvd--wrapper a:focus{box-shadow:0 0 1px 2px rgba(88,144,255,.75),0 1px 1px rgba(0,0,0,.15);outline:none}.fbvd--wrapper b{font-size:13px;position:relative;top:1px;color:#3b5998;font-weight:400}</style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style>video::-internal-media-controls-download-button {display:none;}video::-webkit-media-controls-enclosure {overflow:hidden;}video::-webkit-media-controls-panel {width: calc(100% + 30px); }audio::-internal-media-controls-download-button {display:none;}audio::-webkit-media-controls-enclosure {overflow:hidden;}audio::-webkit-media-controls-panel {width: calc(100% + 30px); }</style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style id="diy_style" type="text/css"></style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style id="diy_style" type="text/css"></style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style type="text/css">.pcb{margin-right:0}</style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style type="text/css">
#fastposteditor{
position:relative;
}
#fastposteditor .tedt{
position:relative;
z-index:1;
}
#fastposteditor .tedt .area{
background:none;
}
#fastposteditor .tedt .pt{
background:none;
}
#rsf_lgf_bg{
width:auto;
height:auto;
position:absolute;
top:26px;
left:1px;
z-index:0;
max-height:130px;
overflow:hidden;
text-align:center;
}
#rsf_lgf_bg img{
width:auto;
max-height:130px;
margin:0 auto;
filter:alpha(opacity='90');
zoom:1;	
}
</style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style>.cardstyle_277 { background: url("") !important;}.cardstyle_277 { color: #000000;}.cardstyle_277 a { color: #000000;}.cardstyle_277 a:hover { color: #000000;}.cardstyle_277 .xi2 { color: #000000;}.cardstyle_277 .xi1 { color: #F26C4F;}.cardstyle_276 { background: url("") !important;}.cardstyle_276 { color: #000000;}.cardstyle_276 a { color: #000000;}.cardstyle_276 a:hover { color: #000000;}.cardstyle_276 .xi2 { color: #000000;}.cardstyle_276 .xi1 { color: #F26C4F;}.cardstyle_275 { background: url("") !important;}.cardstyle_275 { color: #000000;}.cardstyle_275 a { color: #000000;}.cardstyle_275 a:hover { color: #000000;}.cardstyle_275 .xi2 { color: #000000;}.cardstyle_275 .xi1 { color: #F26C4F;}.cardstyle_274 { background: url("") !important;}.cardstyle_274 { color: #000000;}.cardstyle_274 a { color: #000000;}.cardstyle_274 a:hover { color: #000000;}.cardstyle_274 .xi2 { color: #000000;}.cardstyle_274 .xi1 { color: #F26C4F;}.cardstyle_273 { background: url("") !important;}.cardstyle_273 { color: #66FF66;}.cardstyle_273 a { color: #66FF66;}.cardstyle_273 a:hover { color: #66FF66;}.cardstyle_273 .xi2 { color: #66FF66;}.cardstyle_273 .xi1 { color: #F26C4F;}.cardstyle_272 { background: url("") !important;}.cardstyle_272 { color: #000000;}.cardstyle_272 a { color: #000000;}.cardstyle_272 a:hover { color: #000000;}.cardstyle_272 .xi2 { color: #000000;}.cardstyle_272 .xi1 { color: #F26C4F;}.cardstyle_271 { background: url("") !important;}.cardstyle_271 { color: #0033FF;}.cardstyle_271 a { color: #0033FF;}.cardstyle_271 a:hover { color: #0033FF;}.cardstyle_271 .xi2 { color: #0033FF;}.cardstyle_271 .xi1 { color: #F26C4F;}.cardstyle_270 { background: url("") !important;}.cardstyle_270 { color: #00FF00;}.cardstyle_270 a { color: #00FF00;}.cardstyle_270 a:hover { color: #00FF00;}.cardstyle_270 .xi2 { color: #00FF00;}.cardstyle_270 .xi1 { color: #F26C4F;}.cardstyle_269 { background: url("") !important;}.cardstyle_269 { color: #000000;}.cardstyle_269 a { color: #000000;}.cardstyle_269 a:hover { color: #000000;}.cardstyle_269 .xi2 { color: #000000;}.cardstyle_269 .xi1 { color: #F26C4F;}.cardstyle_268 { background: url("") !important;}.cardstyle_268 { color: #0000FF;}.cardstyle_268 a { color: #0000FF;}.cardstyle_268 a:hover { color: #0000FF;}.cardstyle_268 .xi2 { color: #0000FF;}.cardstyle_268 .xi1 { color: #F26C4F;}.cardstyle_267 { background: url("") !important;}.cardstyle_267 { color: #CC9966;}.cardstyle_267 a { color: #CC9966;}.cardstyle_267 a:hover { color: #CC9966;}.cardstyle_267 .xi2 { color: #CC9966;}.cardstyle_267 .xi1 { color: #F26C4F;}.cardstyle_266 { background: url("") !important;}.cardstyle_266 { color: #000000;}.cardstyle_266 a { color: #000000;}.cardstyle_266 a:hover { color: #000000;}.cardstyle_266 .xi2 { color: #000000;}.cardstyle_266 .xi1 { color: #F26C4F;}.cardstyle_265 { background: url("") !important;}.cardstyle_265 { color: #66FF99;}.cardstyle_265 a { color: #66FF99;}.cardstyle_265 a:hover { color: #66FF99;}.cardstyle_265 .xi2 { color: #66FF99;}.cardstyle_265 .xi1 { color: #F26C4F;}.cardstyle_264 { background: url("") !important;}.cardstyle_264 { color: #0066FF;}.cardstyle_264 a { color: #0066FF;}.cardstyle_264 a:hover { color: #0066FF;}.cardstyle_264 .xi2 { color: #0066FF;}.cardstyle_264 .xi1 { color: #F26C4F;}.cardstyle_263 { background: url("") !important;}.cardstyle_263 { color: #FFFF99;}.cardstyle_263 a { color: #FFFF99;}.cardstyle_263 a:hover { color: #FFFF99;}.cardstyle_263 .xi2 { color: #FFFF99;}.cardstyle_263 .xi1 { color: #F26C4F;}.cardstyle_262 { background: url("") !important;}.cardstyle_262 { color: #66FF99;}.cardstyle_262 a { color: #66FF99;}.cardstyle_262 a:hover { color: #66FF99;}.cardstyle_262 .xi2 { color: #66FF99;}.cardstyle_262 .xi1 { color: #F26C4F;}.cardstyle_261 { background: url("") !important;}.cardstyle_261 { color: #FFFFFF;}.cardstyle_261 a { color: #FFFFFF;}.cardstyle_261 a:hover { color: #FFFFFF;}.cardstyle_261 .xi2 { color: #FFFFFF;}.cardstyle_261 .xi1 { color: #F26C4F;}.cardstyle_260 { background: url("") !important;}.cardstyle_260 { color: #99FF66;}.cardstyle_260 a { color: #99FF66;}.cardstyle_260 a:hover { color: #99FF66;}.cardstyle_260 .xi2 { color: #99FF66;}.cardstyle_260 .xi1 { color: #F26C4F;}.cardstyle_259 { background: url("") !important;}.cardstyle_259 { color: #0066FF;}.cardstyle_259 a { color: #0066FF;}.cardstyle_259 a:hover { color: #0066FF;}.cardstyle_259 .xi2 { color: #0066FF;}.cardstyle_259 .xi1 { color: #F26C4F;}.cardstyle_258 { background: url("") !important;}.cardstyle_258 { color: #FFFF66;}.cardstyle_258 a { color: #FFFF66;}.cardstyle_258 a:hover { color: #FFFF66;}.cardstyle_258 .xi2 { color: #FFFF66;}.cardstyle_258 .xi1 { color: #F26C4F;}.cardstyle_257 { background: url("") !important;}.cardstyle_257 { color: #000000;}.cardstyle_257 a { color: #000000;}.cardstyle_257 a:hover { color: #000000;}.cardstyle_257 .xi2 { color: #000000;}.cardstyle_257 .xi1 { color: #F26C4F;}.cardstyle_256 { background: url("") !important;}.cardstyle_256 { color: #000000;}.cardstyle_256 a { color: #000000;}.cardstyle_256 a:hover { color: #000000;}.cardstyle_256 .xi2 { color: #000000;}.cardstyle_256 .xi1 { color: #F26C4F;}.cardstyle_255 { background: url("") !important;}.cardstyle_255 { color: #000000;}.cardstyle_255 a { color: #000000;}.cardstyle_255 a:hover { color: #000000;}.cardstyle_255 .xi2 { color: #000000;}.cardstyle_255 .xi1 { color: #F26C4F;}.cardstyle_254 { background: url("") !important;}.cardstyle_254 { color: #FFFFFF;}.cardstyle_254 a { color: #FFFFFF;}.cardstyle_254 a:hover { color: #FFFFFF;}.cardstyle_254 .xi2 { color: #FFFFFF;}.cardstyle_254 .xi1 { color: #F26C4F;}.cardstyle_253 { background: url("") !important;}.cardstyle_253 { color: #FF0000;}.cardstyle_253 a { color: #FF0000;}.cardstyle_253 a:hover { color: #FF0000;}.cardstyle_253 .xi2 { color: #FF0000;}.cardstyle_253 .xi1 { color: #F26C4F;}.cardstyle_250 { background: url("") !important;}.cardstyle_250 { color: #FFFFFF;}.cardstyle_250 a { color: #FFFFFF;}.cardstyle_250 a:hover { color: #FFFFFF;}.cardstyle_250 .xi2 { color: #FFFFFF;}.cardstyle_250 .xi1 { color: #F26C4F;}.cardstyle_249 { background: url("") !important;}.cardstyle_249 { color: #FFFFFF;}.cardstyle_249 a { color: #FFFFFF;}.cardstyle_249 a:hover { color: #FFFFFF;}.cardstyle_249 .xi2 { color: #FFFFFF;}.cardstyle_249 .xi1 { color: #F26C4F;}.cardstyle_248 { background: url("") !important;}.cardstyle_248 { color: #000000;}.cardstyle_248 a { color: #000000;}.cardstyle_248 a:hover { color: #000000;}.cardstyle_248 .xi2 { color: #000000;}.cardstyle_248 .xi1 { color: #F26C4F;}.cardstyle_245 { background: url("") !important;}.cardstyle_245 { color: #000000;}.cardstyle_245 a { color: #000000;}.cardstyle_245 a:hover { color: #000000;}.cardstyle_245 .xi2 { color: #000000;}.cardstyle_245 .xi1 { color: #F26C4F;}.changestyle {display: block;position: absolute;right: 0;top: 0;height: 25px;width: 25px;background: url("");}.card {border-radius: 6px;}</style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style type="text/css"> 
#scrolltop {
   display: none;
}
ul#navmenu ul
{ 
display: none; 
position: absolute; 
left: -233px;
bottom: 5px;
} 
ul#navmenu li:hover ul ul, 
ul#navmenu li.iehover ul ul,  { 
display: none; 
} 
ul#navmenu li:hover ul, 
ul#navmenu ul li:hover ul, 
ul#navmenu ul ul li:hover ul, 
ul#navmenu li.iehover ul, 
ul#navmenu ul li.iehover ul, 
ul#navmenu ul ul li.iehover ul { 
display: block; 
} 

#jz52top a {margin: 6px 0;}

#jz52top { z-index: 200; visibility: visible; right: 8px; }

#jz52topa { visibility: hidden;}
#jz52top, #jz52top a { border: none;}

#jz52top { position: fixed; bottom: 290px; display: block; width: 50px; background: none repeat scroll 0% 0% transparent; border: 0px #cdcdcd solid; border-radius: 3px; border-top: 0; cursor: pointer; }
#jz52top:hover { text-decoration: none; }

#jz52top a { display: block; width: 50px; height: 50px; padding: 0; line-height: 12px; text-align: center; color: #787878; text-decoration: none; background: #7f7f7f url("") no-repeat 0 0; border-top: 0px #cdcdcd solid; }

                a.jz52topa:hover { background-position: -50px 0px !important;}
a.replyfast { background-position: 0 -50px !important; }
a.replyfast:hover { background-position: -50px -50px !important;}
a.returnlist { background-position: 0 -100px !important; }
a.returnlist:hover { background-position: -50px -100px !important;}
a.returnboard { background-position: -100px -300px !important; }
a.returnboard:hover { background-position: -150px -300px !important;}
a.jzqr { background-position: 0 -150px !important; }
a.jzqr:hover { background-position: -50px -150px !important;}	
                a.jzwx { background-position: 0 -400px !important; }
a.jzwx:hover { background-position: -50px -400px !important;}				
a.jzkf { background-position: -100px 0px !important; }
a.jzkf:hover { background-position: -150px -0px !important;}
a.jzfx { background-position: -100px -50px !important; }
a.jzfx:hover { background-position: -150px -50px !important;}
.jzfxn { background: #fff !important; width: 231px !important; height: 260px !important; }
a.jzlast { background-position: -100px -100px !important; }
a.jzlast:hover { background-position: -150px -100px !important;}
a.jznext { background-position: -100px -150px !important; }
a.jznext:hover { background-position: -150px -150px !important;}	
                a.jzxyy { background-position: -100px -150px !important; }
a.jzxyy:hover { background-position: -150px -450px !important;}					
a.jzsct { background-position: 0px -200px !important; }
a.jzsct:hover { background-position: -50px -200px !important;}				
a.jzscb { background-position: -100px -200px !important; }
a.jzscb:hover { background-position: -150px -200px !important;}				
a.jzqqq { background-position: 0px -250px !important; }
a.jzqqq:hover { background-position: -50px -250px !important;}
                a.jzsoso { background-position: -100px -400px !important; }
a.jzsoso:hover { background-position: -150px -400px !important;}					
a.jzwo { background-position: -100px -250px !important; }
a.jzwo:hover { background-position: -150px -250px !important;}
a.jzzdy { background-position: 0px -300px !important; }
a.jzzdy:hover { background-position: -50px -300px !important;}
a.jzfbzt { background-position: 0px -350px !important; }
a.jzfbzt:hover { background-position: -50px -350px !important;}
a.jzkfzx { background-position: -100px -350px !important; }
a.jzkfzx:hover { background-position: -150px -350px !important;}



#jzqrn { background: #fff !important; width: 231px !important; height: 260px !important; }
#jzqrn { border: 1px solid rgb(210, 210, 210); text-align: center; }
#jzqrn p {
    font-size: 15px;
    padding-bottom: 15px;
    text-align: center;
color: #999;
    font-family: Microsoft YaHei;
}
#jzwon { background: #fff !important; width: 231px !important; height: 260px !important; }
#jzwon { border: 1px solid rgb(210, 210, 210); }
#jzfxn { border: 1px solid rgb(210, 210, 210); }
#jzfxn h3 {
    height: 23px;
    background: none repeat scroll 0% 0% rgb(250, 250, 250);
    border-bottom: 1px solid rgb(236, 236, 236);
    padding: 10px 0px 0px 10px;
}
#jzfxn .bdsharebuttonbox { padding: 13px 0px 0px 20px; }
#jzfxn .bdsharebuttonbox a, #jzfxn .bdsharebuttonbox .bds_more {
    float: left;
    font-size: 12px;
    padding-left: 25px;
    line-height: 16px;
text-align: left;
    height: 16px;
    background: url("") no-repeat scroll 0px 0px ;
    background-repeat: no-repeat;
    cursor: pointer;
    margin: 6px 6px 6px 0px;
text-indent: 0;
    overflow: hidden;
width: 68px;
}
#jzfxn .bdsharebuttonbox .bds_qzone {
    background-position: 0px -52px !important;
}
#jzfxn .bdsharebuttonbox .bds_tsina {
    background-position: 0px -104px !important;
}
#jzfxn .bdsharebuttonbox .bds_tqq {
    background-position: 0px -260px !important;
}
#jzfxn .bdsharebuttonbox .bds_renren {
    background-position: 0px -208px !important;
}
#jzfxn .bdsharebuttonbox .bds_tqf {
    background-position: 0px -364px !important;
}
#jzfxn .bdsharebuttonbox .bds_tieba {
    background-position: 0px -728px !important;
}
#jzfxn .bdsharebuttonbox .bds_sqq {
    background-position: 0px -2652px !important;
}
#jzfxn .bdsharebuttonbox .bds_hi {
    background-position: 0px -416px !important;
}
#jzfxn .bdsharebuttonbox .bds_isohu {
    background-position: 0px -3016px !important;
}
#jzfxn .bdsharebuttonbox .bds_weixin {
    background-position: 0px -1612px !important;
}
#jzfxn .bdsharebuttonbox .bds_t163 {
    background-position: 0px -832px !important;
}
#jzfxn .bdsharebuttonbox .bds_tsohu {
    background-position: 0px -520px !important;
}
#jzfxn .bdsharebuttonbox .bds_baidu {
    background-position: 0px -2600px !important;
}
#jzfxn .bdsharebuttonbox .bds_qq {
    background-position: 0px -624px !important;
}
#jz52top a b {
    visibility: hidden;
    font-weight: normal;
}
</style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style type="text/css">

#jzmms{padding: 2px; text-align: right; }
.navbar-unread {
    background-color: #E74C3C;
    border-radius: 30px;
    color: #FFF;
    font-size: 11px;
    font-weight: 500;
    line-height: 17px;
    min-width: 8px;
    padding: 0px 4px;
    right: 0px;
    text-align: center;
    text-shadow: none;
    z-index: 10;
align: right;
}

.navbar-unreadn {
    background: url("") no-repeat scroll 0px 0px ;
    border-radius: 30px;
    color: #FFF;
    font-size: 11px;
    font-weight: 500;
    line-height: 17px;
    min-width: 8px;
    padding: 0px 4px;
    right: 0px;
    text-align: center;
    text-shadow: none;
    z-index: 10;
align: right;
}	

#jzgrzxkp {
height: 260px;
width: 231px;
background:#f2f6f8;
font-family: Microsoft YaHei;
}

#jzgrzxkp .jzgrzxkptop {
height: 140px;
background:  url("") no-repeat 0 0 #0079b8 ;
color: #fff;
}
#jzgrzxkp .jzgrzxkptop a{

color: #fff;
}

#jzgrzxkp .jzgrzxkptop h3 {
 height: 16px;
font-weight:normal;
    padding: 8px 0px 0px 10px;
font-size: 16px;
}

#jzgrzxkp .jzgrzxkptop .jzgrzxkpthtle {
height: 35px;
}
#jzgrzxkp .jzgrzxkptop .jzgrzxkpimg {
height: 65px;
text-align:center;
}

#jzgrzxkp .jzgrzxkptop .jzgrzxkpimg img {
width: 54px;
width: 54px;
border-radius: 100px;
margin-top: 2px;


}

#jzgrzxkp .jzgrzxkptop .jzgrzxkpimg .jzgrzxkpimgn {
width: 58px;
height: 58px;
border-radius: 100px;
background: none repeat scroll 0% 0% #fff;
margin-top: 5px;
margin-right: auto;
    margin-left: auto;
}

#jzgrzxkp .jzyhm {
    font-size: 15px;
    line-height: 22px;
text-align: center;
padding-bottom: 10px;
text-align:center;
}

#jzgrzxkp .jzyhm a {
    width: 231px;
    height: 15px;
text-align:center;
background: none ;
}

#jzgrzxkp .jzgrzxkpbox  { height: 120px; background:#f1f1f1;}

#jzgrzxkp .jzgrzxkpbox a { background:url("") no-repeat 0 0  ;  width:57px;height:60px;float:left; margin: 0px;}

.box01{background-position: 0px 0px !important;}
.box02{background-position: -57px 0px !important;}
.box03{background-position: -114px 0px !important;}
.box04{background-position: -171px 0px !important;}

.box05{background-position: 0px -60px !important;}
.box06{background-position: -57px -60px !important;}
.box07{background-position: -114px -60px !important;}
.box08{background-position: -171px -60px !important;}
.box09{background-position: 0px -120px !important;}


#jz52-grzx-skin a{
margin: 0px;
top: 0px;
height: 20px;
width: 20px;
overflow: hidden;
background-image: url("");
background-position: 0px 0px;
background-repeat: no-repeat;
position: absolute;
display: block;
right: 0px;
}

</style>
<style class="darkreader darkreader--sync" media="screen"></style>

      <style class="mx-wc-style">
        .mx-wc-main img {max-width: 100%;}
        .mx-wc-main{
          box-sizing: content-box;
          background-color: rgb(25, 26, 27) !important;
          margin: 0 auto;
          margin-top: 20px;
          max-width: 980px;
        }
        @media (min-width: 768px) {
          .mx-wc-main { padding: 15px 15px 80px 15px }
        }
        @media (max-width: 767px) {
          .mx-wc-main { padding: 15px 3px 80px 3px }
        }
  
      </style>
    </head>
    <body style="background-color: #ffffff !important; min-height: 100%; height: auto; position: static !important; overflow: auto !important; padding-bottom: 0px !important;" id="nv_forum" class="pg_viewthread">
      <div class="mx-wc-main">
        <DIV id="wp" class="wp" style="display: block !important;float: none !important;position: relative !important;top: 0 !important;left: 0 !important;border: 0px !important;width: 100% !important;min-width: 100% !important;max-width: 100% !important;height: auto !important;min-height: auto !important;max-height: 100% !important;margin: 0px !important;padding: 0px !important;"><DIV id="ct" class="wp cl" style="display: block !important;float: none !important;position: relative !important;top: 0 !important;left: 0 !important;border: 0px !important;width: 100% !important;min-width: 100% !important;max-width: 100% !important;height: auto !important;min-height: auto !important;max-height: 100% !important;margin: 0px !important;padding: 0px !important;"><DIV id="postlist" class="pl bm" style="display: block !important;float: none !important;position: relative !important;top: 0 !important;left: 0 !important;border: 0px !important;width: 100% !important;min-width: 100% !important;max-width: 100% !important;height: auto !important;min-height: auto !important;max-height: 100% !important;margin: 0px !important;padding: 0px !important;"><DIV id="post_4515384" style="display: block !important;float: none !important;position: relative !important;top: 0 !important;left: 0 !important;border: 0px !important;width: 100% !important;min-width: 100% !important;max-width: 100% !important;height: auto !important;min-height: auto !important;max-height: 100% !important;margin: 0px !important;padding: 0px !important;"><TABLE id="pid4515384" class="plhin" summary="pid4515384" cellspacing="0" cellpadding="0" style="display: table !important;float: none !important;position: relative !important;top: 0 !important;left: 0 !important;border: 0px !important;width: 100% !important;min-width: 100% !important;max-width: 100% !important;height: auto !important;min-height: auto !important;max-height: 100% !important;margin: 0px !important;padding: 0px !important;"><TBODY style="display: block !important;float: none !important;position: relative !important;top: 0 !important;left: 0 !important;border: 0px !important;width: 100% !important;min-width: 100% !important;max-width: 100% !important;height: auto !important;min-height: auto !important;max-height: 100% !important;margin: 0px !important;padding: 0px !important;"><TR style="display: block !important;float: none !important;position: relative !important;top: 0 !important;left: 0 !important;border: 0px !important;width: 100% !important;min-width: 100% !important;max-width: 100% !important;height: auto !important;min-height: auto !important;max-height: 100% !important;margin: 0px !important;padding: 0px !important;"><TD class="plc" style="display: block !important;float: none !important;position: relative !important;top: 0 !important;left: 0 !important;border: 0px !important;width: 100% !important;min-width: 100% !important;max-width: 100% !important;height: auto !important;min-height: auto !important;max-height: 100% !important;margin: 0px !important;padding: 0px !important;"><DIV class="pct" style="display: block !important;float: none !important;position: relative !important;top: 0 !important;left: 0 !important;border: 0px !important;width: 100% !important;min-width: 100% !important;max-width: 100% !important;height: auto !important;min-height: auto !important;max-height: 100% !important;margin: 0px !important;padding: 0px !important;"><DIV class="pcb" style="display: block !important;float: none !important;position: relative !important;top: 0 !important;left: 0 !important;border: 0px !important;width: 100% !important;min-width: 100% !important;max-width: 100% !important;height: auto !important;min-height: auto !important;max-height: 100% !important;margin: 0px !important;padding: 0px !important;"><DIV class="t_fsz" style="display: block !important;float: none !important;position: relative !important;top: 0 !important;left: 0 !important;border: 0px !important;width: 100% !important;min-width: 100% !important;max-width: 100% !important;height: auto !important;min-height: auto !important;max-height: 100% !important;margin: 0px !important;padding: 0px !important;"><table cellspacing="0" cellpadding="0" class="mx-wc-selected-elem mx-wc-1569638020" style="display: table; float: none !important; position: relative !important; top: 0px !important; left: 0px !important; margin: 0px !important; flex: unset !important; width: 100% !important; max-width: 100% !important; box-sizing: border-box !important;"><tbody><tr><td class="t_f" id="postmessage_4515384">
<i class="pstatus"> 本帖最后由 MotokoX 于 2019-7-15 18:03 编辑 </i><br>
<br>
说实话这东西我也不知道应该发在哪个区orz<br>
本来只是一个菜鸡忙活了一整天才搞出来的一个辣鸡小补丁，为了记录过程写了一个笔记，结果写嗨了的结果。确实这方面的资料比较有限，且与galgame相关的资料就更少了。本人绝对是个菜鸡，初学了一点点就自不量力那种，但我还是恬不知耻地认为，还是可以分享出来一下的，如果有大佬能够加以些许指点，或者能帮助到哪怕一位和我一样的菜鸟，我也不胜感激。<br>
<br>
<font size="6"><font color="#ff0000" data-darkreader-inline-color="" style="--darkreader-inline-color:#e63f3c;">由于过于丢人，本文禁止任何形式的转载。</font></font><br>
<font size="4"><br>
</font><br>
<font size="3">注意：kirikiriZ本身为开源引擎，最好的学习方法是认真阅读源代码，了解其内部读取和解密逻辑，从而逆向写出解包、封包程序。一个很好的例子是Xmoeproject的KirikiriExtract。本文不从源代码入手，以模仿闭源情况，并在过程中试错学习，锻炼能力。</font><br>
<font size="3"><br>
请善用查看大图。<br>
</font><br>
<font size="3">作为例子，载入游戏9-nine-はるいろはるこいはるのかぜ。<br>
环境 windows 8.1 中文版，64位。游戏主程序为32位(nine_haruiro.exe)。<br>
直接双击则报错，点击确定后退出，乱码转换后为“プロダクトIDチェック処理の起動に失敗しました”。若转区启动，则弹出对话框要求输入序列号，输错则重开对话框，无错误提示。<br>
分析如下：kirikiri游戏引擎内核实质上为解释执行用户脚本的虚拟机，按照官网叙述，脚本语言类似于javascript，由此得出以下两点结论：<br>
1. 不适合爆破法，除非校验函数以二进制形式编译在主程序或动态链接库中。<br>
【解释：所谓爆破法，即以nop或无条件跳转等汇编代码直接修改二进制文件，强行忽略或绕过校验函数，它要求校验函数也应以调用或跳转形式存在于二进制程序文件中，即校验函数应该是“写死”的。】<br>
2. 解释执行脚本时脚本应在内存中，要么是接近源代码的形式，要么是初步编译的中间码。前者将会便于观察和修改；后者将会很难办，但相对地，这也大幅增加了引擎开发人员的设计和开发难度，因此可能性不高。<br>
另一点思路：绝大多数虚拟机都是基于堆栈的，运行时栈中可能存在有用的信息。<br>
<br>
首先从对话框入手，使用OllyDbg挂载运行，在函数MessageBoxExW设断，发现触发断点，回到用户程序领空，代码片段如下：<br>
<div align="center">
<ignore_js_op>

<img style="cursor:pointer" id="aimg_94613" aid="94613" src="assets/1569638020-8e6f131d2b07cb58313a02d4c2e09fa9.jpg" onclick="zoom(this, this.getAttribute('zoomfile'), 0, 0, '0')" zoomfile="http://bbs.wojuede.net/forum/201907/13/192536cyd1idi0zzcw5c7c.png" file="http://bbs.wojuede.net/forum/201907/13/192536cyd1idi0zzcw5c7c.png.thumb.jpg" inpost="1" onmouseover="showMenu({'ctrlid':this.id,'pos':'12'})" initialized="true">



</ignore_js_op>
</div><br>
<div align="center">图1</div><br>
<br>
观察上文，没有绕过弹出对话框的条件跳转语句，说明此函数中没有涉及关键的校验正确性判断，那么向上追溯一层函数调用，堆栈中保存的返回地址告诉我们，最近的调用嵌套如下：<br>
<div align="center">
<ignore_js_op>

<img style="cursor:pointer" id="aimg_94614" aid="94614" src="assets/1569638020-70fba4fe0ebaf316c36d271fcec7a1a7.jpg" onclick="zoom(this, this.getAttribute('zoomfile'), 0, 0, '0')" zoomfile="http://bbs.wojuede.net/forum/201907/13/192634q8jxxpznuy5t5yua.png" file="http://bbs.wojuede.net/forum/201907/13/192634q8jxxpznuy5t5yua.png.thumb.jpg" inpost="1" onmouseover="showMenu({'ctrlid':this.id,'pos':'12'})" initialized="true">



</ignore_js_op>
</div><br>
<div align="center">图2</div><br>
先到最近的一层函数调用中观察：<br>
<div align="center">
<ignore_js_op>

<img style="cursor:pointer" id="aimg_94615" aid="94615" src="assets/1569638020-36678eb578aa6a4d68ddf94246b57236.jpg" onclick="zoom(this, this.getAttribute('zoomfile'), 0, 0, '0')" zoomfile="http://bbs.wojuede.net/forum/201907/13/192719bh3o3oq5bth6r3to.png" file="http://bbs.wojuede.net/forum/201907/13/192719bh3o3oq5bth6r3to.png.thumb.jpg" inpost="1" onmouseover="showMenu({'ctrlid':this.id,'pos':'12'})" initialized="true">



</ignore_js_op>
</div><br>
<div align="center">图3</div><br>
向上查阅，依旧没有绕过它的跳转，同时上方的提示中已出现Caption的字符串，很有可能此函数也是只用于错误提示。<br>
再向上一层函数调用，发现：<br>
<br>
<div align="center">
<ignore_js_op>

<img style="cursor:pointer" id="aimg_94616" aid="94616" src="assets/1569638020-1d52f7cf9213dfd2371f799b8b382fc1.jpg" onclick="zoom(this, this.getAttribute('zoomfile'), 0, 0, '0')" zoomfile="http://bbs.wojuede.net/forum/201907/13/192750ukigpwuzhg7oa7w1.png" file="http://bbs.wojuede.net/forum/201907/13/192750ukigpwuzhg7oa7w1.png.thumb.jpg" inpost="1" onmouseover="showMenu({'ctrlid':this.id,'pos':'12'})" initialized="true">



</ignore_js_op>
</div><br>
<div align="center">图4</div><br>
<div align="left">这时应该停下了。分析如下：<br>
1. call eax表明该跳转是运行时根据寄存器中的运算结果动态决定的，而动态决定暗示着该过程是可能被经常调用的(如果只是校验函数中的错误提示，整个程序运行过程中只会碰到一次，那为什么不静态指定跳转目的地址呢？)，一个合理的解释是，该过程是通用的异常处理程序，即Exception Handler，它可以根据需要处理各种不同的异常，所以会动态指定处理过程的目标地址。这不是一个好消息，首先这种处理方式十分适合解释执行脚本语言，校验函数以二进制形式存在于程序中的可能性降低了，我们更不可能通过爆破法简单破解。另外，即使校验函数真的写死在程序中了，它距离错误提示也应该是比较遥远的，至少在异常处理之外，而从海量的反汇编代码中追溯将会是很困难的事情。<br>
2. 向下翻阅堆栈使用情况，发现该程序运行时堆栈使用量很大，且有多个内容指向字符串，如“Information”, “inform”, “System”, “default.tjs”, “execStorage”等，这些内容会给我们很多暗示：System, execStorage会不会是脚本语言的一部分？default.tjs会不会是脚本文件？另外注意，堆栈中时不时会突然出现ASCII字符串“TJS2100”，在大量使用UNICODE字符串的程序中却出现ASCII字符，且考虑到前面出现的tjs后缀，一个可能的解释是TJS2100是储存在脚本文件中文件头部的识别标志，即文件签名(signature)。<br>
由以上分析，我认为应该相信校验函数是作为脚本的一部分出现了，而不应继续考虑爆破法了。<br>
<br>
脚本文件需要主程序以文件I/O方式读入并解释执行(当然也可能作为资源被融合在exe文件本身中了)，重新载入游戏，在CreateFileW、SetFilePointer和ReadFile函数设断。【这些API函数都是需要挨个测试的，例如上文的MessageBoxExW，类似功能的API很多，例如CreateWindow等，简单的方法是类似功能函数全部设断，直到确定这个程序使用的是哪一个】互相配合以观察打开了什么文件、从哪里开始读、读了什么，注意可在数据窗口中追踪Buffer位置，观察读取的信息。它们的调用相当频繁，以下只简单分析要点。<br>
<div align="center">
<ignore_js_op>

<img style="cursor:pointer" id="aimg_94617" aid="94617" src="assets/1569638020-414474c143f6879b752dad87271c4c59.jpg" onclick="zoom(this, this.getAttribute('zoomfile'), 0, 0, '0')" zoomfile="http://bbs.wojuede.net/forum/201907/13/192909udal07fbzbvdllfe.png" file="http://bbs.wojuede.net/forum/201907/13/192909udal07fbzbvdllfe.png.thumb.jpg" inpost="1" onmouseover="showMenu({'ctrlid':this.id,'pos':'12'})" initialized="true">



</ignore_js_op>
</div><br>
<div align="center">图5</div><br>
程序打开了文件data.xp3(大小约502MB)，然后多次从中读取内容。因为调用相当频繁，我们的观察要点在于：脚本文件。前文分析中有一个default.tjs，而该后缀可能指的就是某某script(类比javascript的js，大胆猜一猜嘛)，这暗示着脚本文件可能有tjs的后缀标记。第二，脚本文件的大小不会太大，一般几百B到几KB左右，过大量的读取可能是图片等资源文件。第三，脚本文件应存放于堆中，而前文看到的栈中存放了可能是脚本文件名的信息，因此在可疑的读取前后，记得看看栈中是否有暗示。<br>
根据以上猜想，实际操作时略过读取量不大可能是脚本的读取，例如读11个字节、读EE0C个字节这种直接跳过就好了。<br>
直到有一次调用ReadFile时，参数如下：<br>
<br>
<div align="center">
<ignore_js_op>

<img style="cursor:pointer" id="aimg_94618" aid="94618" src="assets/1569638020-d3c41cb621eaf9b1e4c9e5d7d124dafa.jpg" onclick="zoom(this, this.getAttribute('zoomfile'), 0, 0, '0')" zoomfile="http://bbs.wojuede.net/forum/201907/13/192941fjx71j88784z8raj.png" file="http://bbs.wojuede.net/forum/201907/13/192941fjx71j88784z8raj.png.thumb.jpg" inpost="1" onmouseover="showMenu({'ctrlid':this.id,'pos':'12'})" initialized="true">



</ignore_js_op>
</div><br>
<div align="center">图6</div><br>
这次读取就有可能是读取脚本了，先向下看看堆栈中是否有提示，发现：<br>
<div align="center">
<ignore_js_op>

<img style="cursor:pointer" id="aimg_94619" aid="94619" src="assets/1569638020-f305aee9c20f679a205da85fc30ccf05.jpg" onclick="zoom(this, this.getAttribute('zoomfile'), 0, 0, '0')" zoomfile="http://bbs.wojuede.net/forum/201907/13/193012qi4cgd9evizhfo03.png" file="http://bbs.wojuede.net/forum/201907/13/193012qi4cgd9evizhfo03.png.thumb.jpg" inpost="1" onmouseover="showMenu({'ctrlid':this.id,'pos':'12'})">



</ignore_js_op>
</div><br>
<div align="center">图7</div><br>
<div align="left">这足以引起注意了。“Loading script”直接明示了程序在读取脚本，且脚本后缀就是tjs。在这周围的返回地址应格外注意，因为这些函数在执行时会将脚本名解析出来放在堆栈之中。<br>
在反汇编窗口中查看00E18554附近代码，如下：<br>
<div align="center">
<ignore_js_op>

<img style="cursor:pointer" id="aimg_94620" aid="94620" src="assets/1569638020-445dcc365c1ea8cb9daac2837fea52ab.jpg" onclick="zoom(this, this.getAttribute('zoomfile'), 0, 0, '0')" zoomfile="http://bbs.wojuede.net/forum/201907/13/193055x4zffxxcghkc33rg.png" file="http://bbs.wojuede.net/forum/201907/13/193055x4zffxxcghkc33rg.png.thumb.jpg" inpost="1" onmouseover="showMenu({'ctrlid':this.id,'pos':'12'})">



</ignore_js_op>
</div><br>
<div align="center">图8</div><br>
不妨也将附近几个函数设断，查看其返回情况。<br>
接下来，需要综合已有信息反复试验，寻找有用的函数了，例如哪些函数指明了载入的脚本文件名、哪些函数的返回值有些眼熟或者是人类可读的字符串等等。<br>
【专注某些函数测试时别忘了暂时禁用其他断点以提高效率，注意整个试验过程是极其痛苦且漫长的，感觉不正确就及时放弃，观察返回值、堆栈、寄存器情况，这点只能依靠经验和时间了】<br>
经过一段时间，本人的发现如下：<br>
1. 最临近程序报错前的一次ReadFile操作如下：<br>
<br>
<div align="center">
<ignore_js_op>

<img style="cursor:pointer" id="aimg_94621" aid="94621" src="assets/1569638020-60cd7f123daad463f576d15431e06a1e.jpg" onclick="zoom(this, this.getAttribute('zoomfile'), 0, 0, '0')" zoomfile="http://bbs.wojuede.net/forum/201907/13/193135eanhq3dtaannrqhn.png" file="http://bbs.wojuede.net/forum/201907/13/193135eanhq3dtaannrqhn.png.thumb.jpg" inpost="1" onmouseover="showMenu({'ctrlid':this.id,'pos':'12'})">



</ignore_js_op>
</div><br>
<div align="center">图9</div><br>
向下翻阅堆栈，发现有许多可读的字符串，如“pkeyconf.tjs”, “ProductKeyCheckAndInput”, “pkeycheck.tjs”等，而最令人激动的是出现了以下内容：<br>
<div align="center">
<ignore_js_op>

<img style="cursor:pointer" id="aimg_94622" aid="94622" src="assets/1569638020-c73cf54417a4eebc01980add2a5db7cb.jpg" onclick="zoom(this, this.getAttribute('zoomfile'), 0, 0, '0')" zoomfile="http://bbs.wojuede.net/forum/201907/13/193211d2r2s7kikrpzcdsg.png" file="http://bbs.wojuede.net/forum/201907/13/193211d2r2s7kikrpzcdsg.png.thumb.jpg" inpost="1" onmouseover="showMenu({'ctrlid':this.id,'pos':'12'})">



</ignore_js_op>
</div><br>
<div align="center">图10</div><br>
<div align="left">这就是脚本明文了，观察附近的函数返回地址，从而可能找到是哪个函数把它解析成明文并且压到堆栈中的。(这个代码明文片段出现了两次，分别试验周围的函数调用即可)<br>
在这里找到一个函数：<br>
00EE1A78&nbsp;&nbsp;|.&nbsp;&nbsp;E8 23FAF2FF&nbsp; &nbsp;call nine_har.00E114A0<br>
它离上图的00EE1A88较近，在这里设断并重新载入游戏，每次触发断点时单步步过观察返回值，发现它会返回一个UNICODE字符串指针，内容为脚本代码(因为日文乱码，可能不会被OllyDbg自动解析，请自行将eax指示的地址在数据窗口中追踪查看)，并将eax寄存器压栈，那么我们之前观察到的堆栈中的代码应该就是它干的好事。<br>
<div align="center">
<ignore_js_op>

<img style="cursor:pointer" id="aimg_94623" aid="94623" src="assets/1569638020-e3794944fb8cdef0f94884eaba146ec8.jpg" onclick="zoom(this, this.getAttribute('zoomfile'), 0, 0, '0')" zoomfile="http://bbs.wojuede.net/forum/201907/13/193257uzp433ohtp3n93xq.png" file="http://bbs.wojuede.net/forum/201907/13/193257uzp433ohtp3n93xq.png.thumb.jpg" inpost="1" onmouseover="showMenu({'ctrlid':this.id,'pos':'12'})">



</ignore_js_op>
</div><br>
<div align="center">图11</div><br>
观察它在最后一次的返回内容，使用十六进制编辑软件(或直接利用OllyDbg的数据窗口)将04840474中的内容，直到明显不能被人类阅读为止(准确的说应该用字符串结束标志0x0000判断结束)，全部复制出来并查看。<br>
<div align="center">
<ignore_js_op>

<img style="cursor:pointer" id="aimg_94624" aid="94624" src="assets/1569638020-9f722c0abc15654d47aeb2e20db0c388.jpg" onclick="zoom(this, this.getAttribute('zoomfile'), 0, 0, '0')" zoomfile="http://bbs.wojuede.net/forum/201907/13/193332cqvhshes8ysqaw3n.png" file="http://bbs.wojuede.net/forum/201907/13/193332cqvhshes8ysqaw3n.png.thumb.jpg" inpost="1" onmouseover="showMenu({'ctrlid':this.id,'pos':'12'})">



</ignore_js_op>
</div><br>
<div align="center">图12</div><br>
这就是pkeycheck.tjs的内容。【从内存中拷贝出来的字符是UNICODE宽字符，因此首次打开时应使用UTF16LE-无签名，然后会得到含有乱码的代码，全选复制粘贴到空的新记事本中，以当前系统代码页(GB2312)保存，再以Shift-JIS编码打开便可完全去除乱码。】<br>
2. 在图7所示的00E18554附近，可以看到一个函数<br>
00E18542&nbsp; &nbsp;.&nbsp;&nbsp;E8 598FFFFF&nbsp; &nbsp;call nine_har.00E114A0<br>
它每次执行后都会在eax中返回一个脚本名，推测功能可能是确定接下来要解析的脚本。<br>
<br>
<div align="center">
<ignore_js_op>

<img style="cursor:pointer" id="aimg_94625" aid="94625" src="assets/1569638020-f49842264bc2601497eed973155f9806.jpg" onclick="zoom(this, this.getAttribute('zoomfile'), 0, 0, '0')" zoomfile="http://bbs.wojuede.net/forum/201907/13/193410gu4sfiosoxwsgfgx.png" file="http://bbs.wojuede.net/forum/201907/13/193410gu4sfiosoxwsgfgx.png.thumb.jpg" inpost="1" onmouseover="showMenu({'ctrlid':this.id,'pos':'12'})">



</ignore_js_op>
</div><br>
<div align="center">图13</div><br>
<div align="left">3. 在00E1854F的调用过程中，有一个函数<br>
00E811FA&nbsp;&nbsp;|.&nbsp;&nbsp;FF50 04&nbsp; &nbsp;&nbsp; &nbsp; call dword ptr ds:[eax+0x4]<br>
它每次执行后的edi总是以ASCII“TJS2100”开头，后面可能接一串代码，但并不全都可读，另外，每次调用ReadFile读入一块大小合理的数据时，总会调用00E811FA函数，再根据之前对于“TJS2100”的猜测，该函数的作用可能为解压文件，准备交给后续的函数进行解密。<br>
<br>
结合我们的分析，有了以上信息我们就可以开始进行破解了。<br>
<br>
在本人破解的过程中使用的方法如下，因为在实践过程中没有完整的概念，所以或许方法的发现和入手点看起来较为唐突，过程仅供参考，读者可根据自己的发现来实现。<br>
注意到00EE1A78的脚本解析函数在解析pkeycheck.tjs之前的一次，获得的脚本中最后有这样一句<br>
<div align="center">
<ignore_js_op>

<img style="cursor:pointer" id="aimg_94626" aid="94626" src="assets/1569638020-b74b1b4f296fb957276794e0b288bbe8.jpg" onclick="zoom(this, this.getAttribute('zoomfile'), 0, 0, '0')" zoomfile="http://bbs.wojuede.net/forum/201907/13/193556ta8igohkxaor8zu9.png" file="http://bbs.wojuede.net/forum/201907/13/193556ta8igohkxaor8zu9.png.thumb.jpg" inpost="1" onmouseover="showMenu({'ctrlid':this.id,'pos':'12'})">



</ignore_js_op>
</div><br>
<div align="center">图14</div><br>
这样我们可以得知什么时候会调用pkeycheck.tjs中的函数。<br>
另外，在每次载入游戏，00E811FA处的函数被第一次执行时，它会解压出一块文件，其中包含如下信息：<br>
<br>
<div align="center">
<ignore_js_op>

<img style="cursor:pointer" id="aimg_94627" aid="94627" src="assets/1569638020-a3ebc3c8b70d472e3fa54cbd3584f404.jpg" onclick="zoom(this, this.getAttribute('zoomfile'), 0, 0, '0')" zoomfile="http://bbs.wojuede.net/forum/201907/13/193630qtmm2htrjf3cctii.png" file="http://bbs.wojuede.net/forum/201907/13/193630qtmm2htrjf3cctii.png.thumb.jpg" inpost="1" onmouseover="showMenu({'ctrlid':this.id,'pos':'12'})">



</ignore_js_op>
</div><br>
<div align="center">图15</div><br>
结合图14和图15，我们可以认为，若PACKED == 0，则不会调用校验函数(我没有观察到程序设置过FORCE_PRODUCTKEY这个变量)。那么破解思路就是在00E811FA处设置hook，当该函数被首次调用时，先正常履行其功能，在执行后修改edi开始的数据，将PACKED=1改为PACKED=0。<br>
按照1距离edi位置的偏移，要做的就是<br>
mov BYTE PTR [edi + 017Ch], 30h&nbsp; &nbsp; ;0x30为‘0’的ASCII码(准确的说，0x0030是‘0’的UNICODE码，在文件中保存为小尾顺序)。<br>
以上即为真正起破解作用的一句汇编代码。<br>
接下来开始破解补丁的制作过程，而在最开始有一些很重要的客观因素需要我们分析。<br>
1. 要制作什么样的补丁？<br>
根据以上的所有分析，我们要利用hook技术制作补丁，要做的就是在00E811FA这个函数首次执行后修改其解压出的内容。【关于hook的概念并没有十分简洁的解释，可自行查阅资料并根据下文操作理解。】<br>
2. 00E811FA这个函数存在于哪里？<br>
根据函数的地址，以及内存分布情况(在OllyDbg中按Alt+M可查看当前全部内存块范围)可知它位于nine_haruiro.exe的.text段，即代码段中。这意味着在磁盘中它是位于主程序nine_haruiro.exe中的，而不是被主程序载入的动态链接库中的函数。对于后者则需要考虑更多的问题，如载入时机等，在本例中不做赘述。<br>
3. 重定位问题<br>
在本例中，一个很严重的问题便是重定位。判断程序是否有重定位的一个好方法便是重启计算机，然后再次使用OllyDbg载入游戏，这时会发现原来00E811FA处的函数却变为了003A11FA<br>
<br>
<div align="center">
<ignore_js_op>

<img style="cursor:pointer" id="aimg_94628" aid="94628" src="assets/1569638020-87e7904c3697dc1200cafb9698e84789.jpg" onclick="zoom(this, this.getAttribute('zoomfile'), 0, 0, '0')" zoomfile="http://bbs.wojuede.net/forum/201907/13/193706vhy6n536ln8ggyhn.png" file="http://bbs.wojuede.net/forum/201907/13/193706vhy6n536ln8ggyhn.png.thumb.jpg" inpost="1" onmouseover="showMenu({'ctrlid':this.id,'pos':'12'})">



</ignore_js_op>
</div><br>
<div align="center">图16</div><br>
【如果真的按照这个笔记重做一遍的话会发现前面的所有函数地址都对不上，问题就来源于这里】<br>
这说明游戏的主程序每次被操作系统载入到内存中时使用的是随机基址，也就是说代码映射的位置是不确定的。详细的原理很有讲究，可查阅相关资料。但对我们而言，在破解时就需要警惕了。如果在编程时写死了hook的位置，比如00E811FA，那么写出来的补丁只能正常使用一次，下次换个基址则不知道会发生什么了。<br>
顺便提一个小技巧，可以使用LordPE将游戏主程序中的PE信息进行修改，禁止其重定位，在特征值中勾选重定位已分离即可。<br>
注意这个方法也有一些危险，首先防止重定位可能会导致某些情况下向内存中载入代码时出现冲突，造成程序崩溃。另外修改该值会导致exe文件本身发生了变动，若应用程序有自校验的话可能会被检测到。但取消重定位之后程序中的代码位置就固定了，这时再得到的函数地址是不变且有效的。该方法可用于脱壳等许多其他用途，是个偷懒摸鱼的好技巧。<br>
<br>
<div align="center">
<ignore_js_op>

<img style="cursor:pointer" id="aimg_94629" aid="94629" src="assets/1569638020-94a8a9a76da4d49aa3bc7c1a0cb45487.jpg" onclick="zoom(this, this.getAttribute('zoomfile'), 0, 0, '0')" zoomfile="http://bbs.wojuede.net/forum/201907/13/193739yexxli9tggee918w.png" file="http://bbs.wojuede.net/forum/201907/13/193739yexxli9tggee918w.png.thumb.jpg" inpost="1" onmouseover="showMenu({'ctrlid':this.id,'pos':'12'})">



</ignore_js_op>
</div><br>
<div align="center">图17</div><br>
4. 堆栈的限制<br>
kirikiri本身是基于堆栈的虚拟机，因此在hook时存在一个很严重的问题——我们必须保证堆栈环境的正确。基于堆栈的虚拟机会在堆栈中大量保存运行环境，所以堆栈的内容是紧密相关的，而若我们在hook时修改了堆栈中的内容，又退到虚拟机中运行，则很可能导致程序崩溃。<br>
例如：正常的虚拟机逻辑中，函数A→函数B→函数C，其中函数B取用了函数A留在堆栈中的内容(比如mov al, BYTE PTR [esp – 04h])。当我们hook时，可能会变为这样：函数A→进入hook函数→函数B→退出hook函数→函数C。乍一看没有问题，然而进入hook函数时，系统会将返回地址压栈，而这一变化就会导致函数B取出的数据不正确(位置上相对栈顶的偏移不对了)。<br>
因此考虑hook逻辑的实现，我们在00E811FA之后，即00E81200作为真正的hook位置，它好在edi还没发生变动，且可以较好地实现“只有第一次被调用时才修改内容”的逻辑。<br>
下面正式开始破解补丁的编写：<br>
1.这里不采用更改PE属性的方法，而是在补丁注入时检测内存基址，动态计算hook位置。<br>
【接下来的内容主要与PE知识有关，若觉得难以理解可直接使用前文技巧跳过本节，但需要自己通过OllyDbg确定基址固定后的函数位置。】<br>
主要使用公式：File Offset = VA – ImageBase – Δk<br>
其中File Offset指的是代码(机器码)存放在磁盘文件中的偏移，VA指的是exe载入到内存中时，代码在内存中的虚拟地址，Δk指的是代码所在区块的虚拟偏移量与文件偏移量的差。<br>
在本例中，区块信息如下：<br>
<br>
<div align="center">
<ignore_js_op>

<img style="cursor:pointer" id="aimg_94630" aid="94630" src="assets/1569638020-5dafec4bd2375b57a5cc36a0233038f7.jpg" onclick="zoom(this, this.getAttribute('zoomfile'), 0, 0, '0')" zoomfile="http://bbs.wojuede.net/forum/201907/13/193819v5y8n6hxxm55rjwj.png" file="http://bbs.wojuede.net/forum/201907/13/193819v5y8n6hxxm55rjwj.png.thumb.jpg" inpost="1" onmouseover="showMenu({'ctrlid':this.id,'pos':'12'})">



</ignore_js_op>
</div><br>
<div align="center">图18</div><br>
我们关注的函数位于.text段，其Δk = VOffset - ROffset = 0x1000 – 0x0400 = 0x0C00。<br>
本次载入游戏时的ImageBase为00330000<br>
<br>
<div align="center">
<ignore_js_op>

<img style="cursor:pointer" id="aimg_94631" aid="94631" src="assets/1569638020-377ecb5814c46fca978a5c10c8b52f6e.jpg" onclick="zoom(this, this.getAttribute('zoomfile'), 0, 0, '0')" zoomfile="http://bbs.wojuede.net/forum/201907/13/193850nwqxsw41f5q6m57m.png" file="http://bbs.wojuede.net/forum/201907/13/193850nwqxsw41f5q6m57m.png.thumb.jpg" inpost="1" onmouseover="showMenu({'ctrlid':this.id,'pos':'12'})">



</ignore_js_op>
</div><br>
<div align="center">图19</div><br>
<div align="left">接下来我们需要确定目标函数在磁盘文件中的偏移，即File Offset。<br>
如图16所示，本次载入中VA = 003A11FA，则对应的File Offset = 003A11FA – 00330000 – 00000C00 = 000705FA。<br>
在OllyDbg中选中 003A11FA，右键→查看→可执行文件，验证结果正确。<br>
<div align="center">
<ignore_js_op>

<img style="cursor:pointer" id="aimg_94632" aid="94632" src="assets/1569638020-917965148aae865e0dc66949aa070e3d.jpg" onclick="zoom(this, this.getAttribute('zoomfile'), 0, 0, '0')" zoomfile="http://bbs.wojuede.net/forum/201907/13/193924b5u3pqui23pz7uu7.png" file="http://bbs.wojuede.net/forum/201907/13/193924b5u3pqui23pz7uu7.png.thumb.jpg" inpost="1" onmouseover="showMenu({'ctrlid':this.id,'pos':'12'})">



</ignore_js_op>
</div><br>
<div align="center">图20</div><br>
而由前分析，我们真正选中的hook地址的File Offset为这句之后的00070600。<br>
设置hook时，再由VA = File Offset + ImageBase + Δk = 00070600 + ImageBase + 00000C00即可得到实际的内存虚拟地址。<br>
2. 在设计hook函数时，千万小心对于堆栈的保护，必须注意的是通过call调用函数时会将返回地址压栈。本例中使用Microsoft Detours库进行hook，而该库对于inline hook的处理方式并没有明确说明，试错时可以使用OllyDbg的StrongOD插件强行让游戏挂载DLL，可以方便调试，尤其注意触发hook函数周围的执行流程和堆栈操作。<br>
<br>
<br>
综上所述，最终补丁代码如下：</div><div align="left"><div align="left">////////////////////////////////////////////crack.h</div><div align="left">#pragma once</div><br>
<div align="left">#include "detours.h"</div><div align="left">#pragma comment(lib,"detours.lib")</div><br>
<div align="left">typedef int</div><div align="left">(__cdecl* PFN_AfterDecompressFile)(</div><div align="left">&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;void</div><div align="left">&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;);//声明函数指针，由于不确定实际原型，故视为不接受参数</div><br>
<div align="left">extern DWORD BaseAddr;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;//镜像基址</div><br>
<div align="left">extern DWORD AfterDecompressFileVA;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;//真正的hook地址</div><br>
<div align="left">extern PFN_AfterDecompressFile OrgAfterDecompressFile;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;//原函数入口指针(Trampoline)</div><br>
<div align="left">int CrackAfterDecompressFile(void);&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;//hook函数</div><br>
<div align="left">extern "C" __declspec(dllexport) void Useless();&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;//无用的导出函数，只是便于DLL挂载</div><br>
<div align="left">////////////////////////////////////////////crack.cpp</div><div align="left">#include "pch.h"</div><div align="left">#include "crack.h"</div><br>
<div align="left">__declspec(dllexport) void Useless() {}</div><br>
<div align="left">int __declspec(naked) CrackAfterDecompressFile(void)&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;//裸函数形式，防止不必要的堆栈变化</div><div align="left">{</div><div align="left">&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;static bool isFixed = false;</div><div align="left">&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;if (!isFixed) {&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;//只有第一次被调用时修改内存内容</div><div align="left">&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; __asm mov BYTE PTR [edi + 017Ch], 30h</div><div align="left">&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; //上句将edi开始的解压内容中的"1"改为"0"</div><div align="left">&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; isFixed = true;</div><div align="left">&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;}</div><div align="left">&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;__asm jmp DWORD PTR [OrgAfterDecompressFile]</div><div align="left">&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;//使用jmp做跳转，防止破坏堆栈</div><div align="left">}</div><br>
</div><br>
</div><br>
</div><br>
</div><br>
</div><br>
</font><br>
</td></tr></tbody></table></DIV></DIV></DIV></TD></TR></TBODY></TABLE></DIV></DIV></DIV></DIV>
        
      </div>
    </body>
  </html>